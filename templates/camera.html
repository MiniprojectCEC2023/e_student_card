{% extends "base.html" %}

{% block content %}
    <button onclick="startScanner()">Scan Barcode or QR Code</button>
    <div id="scanner-container">
        <video id="video" autoplay playsinline style="width: 100%; height: 100%;"></video>
        <canvas id="canvas" style="display: none;"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>

    <script>
        function startScanner() {
            var video = document.getElementById('video');
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
        
            Quagga.init({
                inputStream : {
                    name : "Live",
                    type : "LiveStream",
                    target: video
                },
                decoder: {
                    readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "qr_reader"]
                }
            }, function(err) {
                if (err) {
                    console.log(err);
                    return
                }
                Quagga.start();
        
                Quagga.onDetected(function(result) {
                    Quagga.stop();
                    window.location.href = "/scan_barcode/" + result.codeResult.code;
                });
            });
        
            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                }
                requestAnimationFrame(tick);
            }
            tick();
        }
        
    </script>
{% endblock %}
